# Baostock 基本面分析选股程序

## 项目概述

这是一个基于 Baostock API 的股票基本面分析和筛选工具。程序通过获取 A 股上市公司的财务数据、成长指标和估值数据，运用一系列基本面分析指标筛选出优质股票，并将结果保存为 CSV、Markdown 和 JSON 格式文件。

## 依赖环境

- Python 3.6+
- 必要的 Python 库：
  - baostock
  - pandas
  - numpy
  - argparse
  - datetime
  - time
  - json
  - os

## 安装说明

1. 克隆或下载项目到本地
2. 安装依赖库：
```bash
pip install baostock pandas numpy
```

## 使用方法

1. 进入项目目录
2. 运行程序：
```bash
python stock_screeners_baostock.py
```
3. 可选参数：
   - `--no-resume`: 不使用缓存恢复，从头开始运行

## 功能说明

### 核心类与方法

#### `StockScreener` 类

- `__init__`: 初始化方法，设置缓存目录、结果目录和各种参数
- `_get_latest_trading_day`: 获取最近的交易日日期
- `login`: 登录 Baostock 系统
- `logout`: 退出 Baostock 系统
- `get_a_share_codes`: 获取所有 A 股代码，并支持从缓存加载
- `save_cache`: 保存当前处理进度到缓存
- `load_cache`: 加载缓存数据
- `get_stock_finance`: 获取单只股票的财务数据
- `calculate_growth_rates`: 计算成长指标
- `get_valuation_data`: 获取股票估值数据
- `screen_high_quality_stocks`: 筛选优质股
- `save_results`: 保存筛选结果到文件
- `run`: 运行完整的选股流程

### 选股流程

1. 登录 Baostock 系统
2. 加载缓存数据（如果有）
3. 获取 A 股所有股票代码
4. 批量获取个股近 3 年财务数据
5. **计算成长指标**：
   - 对每只股票，按股票代码和年份排序财务数据
   - 去除重复的股票代码和年份组合
   - 使用 pivot_table 重塑数据，计算各年度净利润
   - 计算相邻年份间的净利润增长率（避免除以零）
   - 对负增长率进行特殊处理，设置最小增速为5%
6. **获取估值数据**：
   - 检查是否有缓存的估值数据，如果有则加载
   - 按批次处理股票代码（每批次10只）
   - 验证并修复股票代码格式
   - 逐个查询每只股票的估值数据（使用 query_history_k_data_plus API）
   - 处理API返回的数据，提取peTTM（滚动市盈率）和pctChg（涨跌幅）
   - 实现重试机制，对获取失败的股票进行最多3次重试
   - 将有效数据合并到总估值数据列表
   - 定期缓存估值数据到CSV文件
   - 去除重复的估值数据（按股票代码去重）
7. **筛选优质股**：
   - 获取最新年份的财务数据
   - 合并财务数据、成长数据和估值数据
   - 确保股票名称列存在
   - 定义筛选条件：
     - 风险排除：资产负债率 < 85%，经营现金流净额 >= 0，PE-TTM > 0 且 < 80
     - 核心指标：ROE > 10%，毛利率 > 20%，流动比率 > 1.0
   - 应用筛选条件得到优质股列表
   - 如果筛选结果不足，逐步放宽条件：
     - 第一次放宽：资产负债率 < 90%，ROE > 8%，毛利率 > 15%，流动比率 > 0.8
     - 第二次放宽：如果仍无结果，按ROE排序取前15只股票
8. 保存结果
9. 清理缓存并登出

### 筛选条件

程序使用以下条件筛选优质股：

1. 风险排除：
   - 资产负债率 < 85%
   - 经营现金流净额 >= 0
   - PE-TTM > 0 且 < 80

2. 核心指标筛选：
   - ROE > 10%
   - 毛利率 > 20%
   - 流动比率 > 1.0

3. 如果筛选结果不足，程序会逐步放宽条件，并最终按 ROE 排序取前 15 只股票

## 输出结果

程序会在 `result` 目录下生成以下文件：

- `result_selected_baostock.csv`: 筛选结果的 CSV 文件
- `result_selected_baostock.md`: 筛选结果的 Markdown 文件
- `result_selected_baostock.json`: 筛选结果的 JSON 文件（只包含股票代码和名称）

## 优化建议

### 业务优化

1. **增加更多筛选维度**：
   - 加入行业分类筛选功能，支持按行业筛选优质股
   - 增加估值指标如 PB、PS 等，进行多维度估值分析
   - 考虑加入技术分析指标，结合基本面和技术面进行选股

2. **优化筛选策略**：
   - 实现动态调整筛选阈值的功能，根据市场整体情况自动调整
   - 增加回测功能，验证筛选策略的有效性
   - 支持用户自定义筛选条件

3. **数据更新机制**：
   - 实现定期自动更新数据的功能
   - 增加增量更新机制，只获取最新数据而非全部数据

### 代码逻辑优化

1. **性能优化**：
   - 优化 API 调用方式，减少不必要的网络请求
   - 实现并发请求功能，提高数据获取速度
   - 使用更高效的数据结构和算法处理大量数据

2. **异常处理**：
   - 增强异常处理机制，提高程序的健壮性
   - 实现更智能的重试策略，对不同类型的错误采用不同的重试机制
   - 添加详细的日志记录，便于调试和问题定位

3. **代码结构**：
   - 重构代码，将不同功能模块分离成独立文件
   - 增加单元测试，确保代码质量
   - 优化缓存机制，减少磁盘 I/O 操作

4. **用户体验**：
   - 增加进度显示功能，让用户了解程序运行状态
   - 实现可视化界面，方便用户操作和查看结果
   - 提供更详细的结果分析报告

5. **扩展性**：
   - 设计插件系统，支持添加新的数据源和分析模块
   - 实现与其他金融数据 API 的兼容接口
   - 支持导出结果到更多格式（如 Excel、PDF 等）

